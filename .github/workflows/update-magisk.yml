name: Update Magisk Files

# æ¯å‘¨ä¸€å‡Œæ™¨2ç‚¹è¿è¡Œ
on:
  schedule:
    - cron: '0 2 * * 1'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  update-magisk:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up environment
        run: |
          mkdir -p Magisk
          echo "CURRENT_DIR=$(pwd)" >> $GITHUB_ENV

      # æ›´æ–°Magisk.apkï¼ˆtopjohnwu/Magiskï¼‰
      - name: Update Magisk.apk from topjohnwu/Magisk
        run: |
          # è·å–åŒ…æ‹¬é¢„å‘å¸ƒçš„æœ€æ–°release
          RESPONSE=$(curl -s "https://api.github.com/repos/topjohnwu/Magisk/releases?per_page=1&include_prereleases=true")
          
          # æå–åŸºç¡€ä¿¡æ¯
          TAG_NAME=$(echo "$RESPONSE" | jq -r '.[0].tag_name')
          RELEASE_DATE=$(echo "$RESPONSE" | jq -r '.[0].published_at' | cut -c 1-10 | tr -d '-')
          SHORT_DATE=$(echo "$RELEASE_DATE" | sed 's/^..//')
          
          # æå–ç‰ˆæœ¬å·
          VERSION=$(echo "$TAG_NAME" | sed 's/^v//')
          
          # ç¡®å®šå‘å¸ƒæ¸ é“ï¼ˆstable/betaï¼‰
          IS_PRERELEASE=$(echo "$RESPONSE" | jq -r '.[0].prerelease')
          CHANNEL="beta"
          [ "$IS_PRERELEASE" = "false" ] && CHANNEL="stable"
          
          # æŸ¥æ‰¾APKä¸‹è½½é“¾æ¥ï¼ˆåŒ¹é…Magisk-*.apkï¼‰
          APK_URL=$(echo "$RESPONSE" | jq -r '.[0].assets[] | select(.name | test("Magisk-.*\\.apk")) | .browser_download_url')
          
          # æ£€æŸ¥æ˜¯å¦è·å–åˆ°æœ‰æ•ˆä¿¡æ¯
          if [ -z "$APK_URL" ] || [ "$APK_URL" = "null" ]; then
            echo "âŒ æœªæ‰¾åˆ°Magisk APKä¸‹è½½é“¾æ¥"
            exit 0
          fi

          # æå–Source code (zip)çš„ä¸‹è½½é“¾æ¥ï¼ˆGitHubè‡ªåŠ¨ç”Ÿæˆçš„æºç åŒ…ï¼‰
          ZIP_URL=$(echo "$RESPONSE" | jq -r '.[0].zipball_url')
          # åˆ›å»ºä¸´æ—¶ç›®å½•å­˜æ”¾æºç 
          TEMP_DIR="temp_magisk_source"
          mkdir -p "$TEMP_DIR"
          
          # ä¸‹è½½æºç åŒ…
          echo "ğŸ“¥ ä¸‹è½½Magiskæºç åŒ…: $ZIP_URL"
          if ! curl -L --retry 3 "$ZIP_URL" -o "$TEMP_DIR/magisk_source.zip"; then
            echo "âš ï¸  æºç åŒ…ä¸‹è½½å¤±è´¥ï¼Œå°è¯•è·³è¿‡ç‰ˆæœ¬ç æå–"
            VERSION_CODE="unknown"
          else
            # è§£å‹æºç åŒ…ï¼ˆå®‰é™æ¨¡å¼ï¼Œä¸è¾“å‡ºå†—ä½™ä¿¡æ¯ï¼‰
            unzip -q "$TEMP_DIR/magisk_source.zip" -d "$TEMP_DIR"
            # æŸ¥æ‰¾app/gradle.propertiesæ–‡ä»¶ï¼ˆè§£å‹åçš„ç›®å½•åæ˜¯éšæœºçš„ï¼Œç”¨é€šé…ç¬¦åŒ¹é…ï¼‰
            GRADLE_PROPERTIES=$(find "$TEMP_DIR" -path "*/app/gradle.properties" | head -1)
            
            # æå–magisk.versionCode
            if [ -z "$GRADLE_PROPERTIES" ]; then
              echo "âš ï¸  æœªæ‰¾åˆ°app/gradle.propertiesï¼Œç‰ˆæœ¬ç è®¾ä¸ºunknown"
              VERSION_CODE="unknown"
            else
              VERSION_CODE=$(grep -oP 'magisk\.versionCode\s*=\s*\K\d+' "$GRADLE_PROPERTIES")
              if [ -z "$VERSION_CODE" ]; then
                echo "âš ï¸  æœªæå–åˆ°magisk.versionCodeï¼Œè®¾ä¸ºunknown"
                VERSION_CODE="unknown"
              else
                echo "âœ… æå–åˆ°ç‰ˆæœ¬ç : $VERSION_CODE"
              fi
            fi
          fi
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -rf "$TEMP_DIR"
          
          # æ£€æŸ¥æœ¬åœ°ç‰ˆæœ¬æ˜¯å¦å·²ä¸ºæœ€æ–°
          CURRENT_VERSION_INFO=$(cat Magisk/MagiskVer 2>/dev/null | awk -F'[\\[\\]-]' '{print $2 "|" $3}')
          CURRENT_VERSION=$(echo "$CURRENT_VERSION_INFO" | cut -d'|' -f1)
          CURRENT_VERSION_CODE=$(echo "$CURRENT_VERSION_INFO" | cut -d'|' -f2)
          # ç»„åˆå½“å‰ç‰ˆæœ¬ä¿¡æ¯ï¼ˆç”¨äºåˆ¤æ–­æ˜¯å¦æ›´æ–°ï¼‰
          NEW_VERSION_INFO="$VERSION|$VERSION_CODE"
          
          if [ "$CURRENT_VERSION_INFO" = "$NEW_VERSION_INFO" ] && [ "$CURRENT_VERSION" != "" ]; then
            echo "âœ… Magiskå·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼ˆv$VERSION[$VERSION_CODE]ï¼‰ï¼Œæ— éœ€æ›´æ–°"
            exit 0
          fi
          
          # ä¸‹è½½å¹¶æ›´æ–°æ–‡ä»¶
          echo "ğŸ“¥ ä¸‹è½½æœ€æ–°Magisk: $APK_URL"
          curl -L --retry 3 "$APK_URL" -o Magisk/Magisk.apk
          
          # æ›´æ–°ç‰ˆæœ¬æ–‡ä»¶
          VERSION_LINE="Magisk-v$VERSION[$VERSION_CODE]-$CHANNEL-$SHORT_DATE"
          echo "$VERSION_LINE" > Magisk/MagiskVer
          echo "âœ… å·²æ›´æ–°Magiskåˆ°ç‰ˆæœ¬: $VERSION_LINE"

      # æ›´æ–°MagiskAlpha.apkï¼ˆvvb2060/Magiskï¼‰
      - name: Update MagiskAlpha.apk from vvb2060/Magisk
        run: |
          # è·å–æœ€æ–°release
          RESPONSE=$(curl -s "https://api.github.com/repos/vvb2060/Magisk/releases/latest")
          
          # æå–åŸºç¡€ä¿¡æ¯
          TAG_NAME=$(echo "$RESPONSE" | jq -r '.tag_name')
          RELEASE_DATE=$(echo "$RESPONSE" | jq -r '.published_at' | cut -c 1-10 | tr -d '-')
          SHORT_DATE=$(echo "$RELEASE_DATE" | sed 's/^..//')
          
          # æå–ç‰ˆæœ¬ä¿¡æ¯ï¼ˆä»æ ‡é¢˜ä¸­æå–commitä¿¡æ¯ï¼‰
          TITLE=$(echo "$RESPONSE" | jq -r '.name')
          COMMIT=$(echo "$TITLE" | cut -d'-' -f1)
          
          # æŸ¥æ‰¾APKä¸‹è½½é“¾æ¥
          APK_URL=$(echo "$RESPONSE" | jq -r '.assets[] | select(.name == "app-release.apk") | .browser_download_url')
          
          # æ£€æŸ¥æ˜¯å¦è·å–åˆ°æœ‰æ•ˆä¿¡æ¯
          if [ -z "$APK_URL" ] || [ "$APK_URL" = "null" ]; then
            echo "âŒ æœªæ‰¾åˆ°MagiskAlpha APKä¸‹è½½é“¾æ¥"
            exit 0
          fi
          
          # æ£€æŸ¥æœ¬åœ°ç‰ˆæœ¬æ˜¯å¦å·²ä¸ºæœ€æ–°
          CURRENT_TAG=$(cat Magisk/MagiskAlphaVer 2>/dev/null | grep -oP '\[\K\d+' | head -1)
          if [ "$CURRENT_TAG" = "$TAG_NAME" ]; then
            echo "âœ… MagiskAlphaå·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼ˆ$TAG_NAMEï¼‰ï¼Œæ— éœ€æ›´æ–°"
            exit 0
          fi
          
          # ä¸‹è½½å¹¶æ›´æ–°æ–‡ä»¶
          echo "ğŸ“¥ ä¸‹è½½æœ€æ–°MagiskAlpha: $APK_URL"
          curl -L --retry 3 "$APK_URL" -o Magisk/MagiskAlpha.apk
          
          # æ›´æ–°ç‰ˆæœ¬æ–‡ä»¶
          VERSION_LINE="Magisk-$COMMIT-alpha-[$TAG_NAME]-$SHORT_DATE"
          echo "$VERSION_LINE" > Magisk/MagiskAlphaVer
          echo "âœ… å·²æ›´æ–°MagiskAlphaåˆ°ç‰ˆæœ¬: $VERSION_LINE"

      # ç”Ÿæˆæ ¡éªŒå’Œ
      - name: Generate verify.sha256sum
        run: |
          # ç¡®ä¿è„šæœ¬å¯æ‰§è¡Œ
          chmod +x Magisk/genverify.sh
          # è¿è¡Œç”Ÿæˆæ ¡éªŒå’Œçš„è„šæœ¬
          cd Magisk
          ./genverify.sh
          echo "âœ… å·²æ›´æ–°verify.sha256sumæ ¡éªŒå’Œ"

      # æ£€æŸ¥å˜æ›´å¹¶æäº¤
      - name: Check for changes
        id: check_changes
        run: |
          git status
          if git diff --quiet; then
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  æ— æ–‡ä»¶å˜æ›´ï¼Œæ— éœ€æäº¤"
          else
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  æ£€æµ‹åˆ°å˜æ›´ï¼Œå‡†å¤‡æäº¤"
          fi

      - name: Commit and push changes
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add .
          git commit -m "Auto-update Magisk files ($(date +'%Y-%m-%d'))"
          git push
          echo "âœ… å·²æäº¤æ›´æ–°åˆ°ä»“åº“"
